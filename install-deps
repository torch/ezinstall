#!/usr/bin/env bash

######################################################################
# This script installs required dependencies for Torch7
######################################################################

# Based on Platform:
if [[ `uname` == 'Darwin' ]]; then
    # GCC?
    if [[ `which gcc` == '' ]]; then
        echo "MacOS doesn't come with GCC: please install XCode and the command line tools."
        exit
    fi

    # Install Homebrew (pkg manager):
    if [[ `which brew` == '' ]]; then
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/mxcl/homebrew/go/install)"
    fi

    # Install dependencies:
    echo "==> Updating homebrew packages, installing required dependencies. Look at /tmp/ezinstall.log for full output"
    brew update                                         >/tmp/ezinstall.log 2>&1
    brew install git readline cmake wget qt             >/tmp/ezinstall.log 2>&1
    brew install libjpeg imagemagick zeromq             >/tmp/ezinstall.log 2>&1
    brew link readline --force                          >/tmp/ezinstall.log 2>&1
    brew remove gnuplot                                 >/tmp/ezinstall.log 2>&1
    brew install gnuplot --wx --cairo --pdf --with-x    >/tmp/ezinstall.log 2>&1

elif [[ `uname` == 'Linux' ]]; then
    # Aptitude?
    if [[ `which apt-get` == '' ]]; then
        echo '==> apt-get not found, platform not supported'
        exit
    fi

    echo "==> Install dependencies for Torch. Look at /tmp/ezinstall.log for full output"
    echo "==> Installing via apt-get zeromq, node.js, build essentials, readline, git, libjpeg, libpng, ncurses, imagemagick, gnuplot"
    sudo apt-get install -y python-software-properties          >/tmp/ezinstall.log 2>&1
    yes | sudo add-apt-repository ppa:chris-lea/zeromq            >/tmp/ezinstall.log 2>&1
    yes | sudo add-apt-repository ppa:chris-lea/node.js           >/tmp/ezinstall.log 2>&1
    sudo apt-get update                                         >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y build-essential                     >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y gcc g++                             >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y cmake                               >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y curl                                >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y libreadline-dev                     >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y git-core                            >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y libqt4-core libqt4-gui libqt4-dev   >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y libjpeg-dev                         >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y libpng-dev                          >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y ncurses-dev                         >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y imagemagick                         >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y libzmq-dev                          >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y gfortran                            >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y unzip                               >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y gnuplot                             >/tmp/ezinstall.log 2>&1
    sudo apt-get install -y gnuplot-x11                         >/tmp/ezinstall.log 2>&1
    sudo apt-get update                                         >/tmp/ezinstall.log 2>&1

    # Get and build OpenBlas (Torch is much better with a decent Blas)
    echo "Compiling and installing the latest and greatest OpenBLAS"
    cd /tmp/
    git clone https://github.com/xianyi/OpenBLAS.git    >/tmp/ezinstall.log 2>&1
    cd OpenBLAS
    make NO_AFFINITY=1 USE_OPENMP=1                     >/tmp/ezinstall.log 2>&1
    RET=$?; if [ $RET -ne 0 ]; then
	      echo "Error. OpenBLAS could not be compiled. Look at /tmp/ezinstall.log for more details";
	      exit $RET;
    fi
    sudo make install                                   >/tmp/ezinstall.log 2>&1
    RET=$?; if [ $RET -ne 0 ]; then
        echo "Error. OpenBLAS could not be compiled. Look at /tmp/ezinstall.log for more details";
	      exit $RET;
    fi

else
    # Unsupported
    echo '==> platform not supported, aborting'
    exit
fi

# Done.
echo "==> Torch7's dependencies have been installed"
